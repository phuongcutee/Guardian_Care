<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GuardianCare</title>
    <link rel="icon" type="image/x-icon" href="assets/logo.ico">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="assets/js/firebase-config.js"></script>
  <script src="assets/js/app-config.js"></script>
</head>
<body class="bg-gray-50">
    <custom-navbar></custom-navbar>
    
    <main class="container mx-auto px-6 py-10">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold">Welcome back, <span id="userName">User</span></h1>
            <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Logout</button>
        </div>

        <div class="grid md:grid-cols-3 gap-8 mb-10">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex items-center mb-4">
                    <div class="bg-indigo-100 p-3 rounded-full mr-4">
                        <i data-feather="activity" class="text-indigo-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Active Monitoring</p>
                        <h3 class="text-2xl font-bold">24/7</h3>
                    </div>
                </div>
                <p class="text-gray-600">Your system is actively monitoring for falls</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex items-center mb-4">
                    <div class="bg-green-100 p-3 rounded-full mr-4">
                        <i data-feather="check-circle" class="text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Last Check</p>
                        <h3 class="text-2xl font-bold" id="lastCheck">5 min ago</h3>
                    </div>
                </div>
                <p class="text-gray-600">System is functioning normally</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 p-3 rounded-full mr-4">
                        <i data-feather="bell" class="text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Alerts</p>
                        <h3 class="text-2xl font-bold" id="alertCount">0</h3>
                    </div>
                </div>
                <p class="text-gray-600"><span id="alertsCount">0</span>
No recent incidents detected</p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4">Product Demo</h2>
                <div class="relative rounded-lg overflow-hidden" style="padding-top:56.25%">
                  <iframe id="productDemoFrame" class="absolute inset-0 w-full h-full" src="" 
                          title="Product Demo Video" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
                <div class="mt-4 flex justify-between">
                    <button id="openLiveDemoBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <i data-feather="monitor"></i> Live Demo
                    </button>
                    <a href="pricing.html" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-center gap-2">
                        <i data-feather="shopping-cart"></i> Pricing
                    </a>
                </div>
            </div>

            
                    <p class="text-gray-600 mb-4">Next billing date: <span id="nextBilling">June 15, 2023</span></p>
                    <button id="upgradeBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Upgrade Plan</button>
                </div><h3 class="font-semibold mb-2">Pay via QR Code</h3>
                    <img src="assets/payment-qr.png" alt="Payment QR Code" class="w-40 h-40 mx-auto mb-4">
                    <p class="text-gray-600 text-center">Scan to pay via mobile banking</p>
                </div>
            </div>
        </div>
    
<section class="grid md:grid-cols-2 gap-8 mb-10"><div id="toolRemain" class="text-2xl font-bold mt-1">Free plan (no expiry set)</div>
      <button 
    </div>
  </div>
  <div class="bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-xl font-semibold mb-2">Emergency Test</h2>
    <p class="text-gray-600 mb-4">Send a test alert to email and Telegram (configurable).</p>
    <button id="testEmergencyBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Test Emergency</button>
  </div>
</section>

</main>

    <custom-footer></custom-footer>
    
    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script src="assets/js/script.js"></script>
    <script>
        feather.replace();
        
        // Firebase Auth State Listener
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = '/';
            } else {
                document.getElementById('userName').textContent = user.email.split('@')[0];
                
                // Lấy thông tin subscription từ Firestore
                const db = firebase.firestore();
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().expiryDate) {
                        const expiryDate = doc.data().expiryDate.toDate();
                        capNhatThoiGianConLai(expiryDate);
                        // Cập nhật mỗi phút
                        setInterval(() => capNhatThoiGianConLai(expiryDate), 60000);
                    }
                });
            }
        });

        // Hàm tính và hiển thị thời gian còn lại
        function capNhatThoiGianConLai(expiryDate) {
            const now = new Date();
            const remainingMs = expiryDate - now;
            
            if (remainingMs <= 0) {
                document.getElementById('toolRemain').textContent = 'Gói dịch vụ đã hết hạn';
                return;
            }

            const days = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((remainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('toolRemain').textContent = 
                `${days}d ${hours}h ${minutes}m còn lại`;
        }

        // Logout Functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = '/';
            });
        });

        // Demo Video Play
        let isPlaying = false;
        const demoImage = document.getElementById('demoImage');
        const playBtn = document.getElementById('playBtn');
        
        playBtn.addEventListener('click', () => {
            if (!isPlaying) {
                demoImage.src = 'assets/demo-animation.gif';
                playBtn.innerHTML = '<i data-feather="pause"></i> Pause Demo';
                isPlaying = true;
            } else {
                demoImage.src = 'assets/demo-feed.jpg';
                playBtn.innerHTML = '<i data-feather="play"></i> Play Demo';
                isPlaying = false;
            }
            feather.replace();
        });

        // Emergency Test
        document.getElementById('emergencyBtn').addEventListener('click', () => {
            alert('Emergency test alert sent to registered contacts!');
        });
    </script>

<style>
.gc-fab { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 60; }
.gc-fab a { width: 48px; height: 48px; border-radius: 9999px; display: flex; align-items: center; justify-content: center;
  background: white; box-shadow: 0 4px 14px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; text-decoration: none; }
</style>
<div class="gc-fab">
  <a href="https://www.facebook.com/" target="_blank" aria-label="Facebook"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg" alt="fb" style="width:22px;height:22px"/></a>
  <a href="https://www.instagram.com/" target="_blank" aria-label="Instagram"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="ig" style="width:22px;height:22px"/></a>
  <a href="https://zalo.me/" target="_blank" aria-label="Zalo"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/zalo.svg" alt="zalo" style="width:22px;height:22px"/></a>
</div>

  <script src="assets/js/social-links.js"></script>

    <!-- v7: Product Demo + Live Demo modal wiring -->
    <script>
      (function(){
        function toEmbed(urlOrId){
          if (!urlOrId) return "";
          try {
            if (!/^https?:\/\//i.test(urlOrId)) return "https://www.youtube.com/embed/" + urlOrId + "?rel=0";
            var u = new URL(urlOrId);
            var v = u.searchParams.get('v');
            if (v) return "https://www.youtube.com/embed/" + v + "?rel=0";
            var p = u.pathname.split('/');
            var idx = p.indexOf('embed');
            if (idx>=0 && p[idx+1]) return "https://www.youtube.com/embed/" + p[idx+1] + "?rel=0";
            if (u.hostname.includes('youtu.be')) {
              var id = u.pathname.replace(/^\//,'').split('/')[0];
              if (id) return "https://www.youtube.com/embed/" + id + "?rel=0";
            }
          } catch(e) {}
          return "";
        }
        // Set demo frame
        var f = document.getElementById('productDemoFrame');
        if (f && window.DEMO_YT_URL) f.src = toEmbed(window.DEMO_YT_URL);
        // Wire Live Demo button
        var liveBtn = document.getElementById('openLiveDemoBtn');
        if (liveBtn) liveBtn.addEventListener('click', function(e){
          e.preventDefault();
          if (window.__openLiveDemoModal) return window.__openLiveDemoModal();
          alert('Live Demo module is under development.');
        });
      })();
    </script>
    <!-- /v7 -->
    

    <!-- v7: activation guard (redirect non-activated users) -->
    <script>
      (function(){
        try {
          if (firebase && firebase.auth){
            firebase.auth().onAuthStateChanged(function(user){
              if (!user) return;
              if (!firebase.firestore) return; // skip if no firestore
              var db = firebase.firestore();
              db.collection('users').doc(user.uid).get().then(function(doc){
                var ok = doc.exists && doc.data() && doc.data().active === true;
                if (!ok){
                  alert('Tài khoản của bạn chưa được admin kích hoạt.');
                  window.location.href = 'index.html';
                }
              });
            });
          }
        } catch(e){ console.warn('activation guard error', e); }
      })();
    </script>
    
</body>
</html>